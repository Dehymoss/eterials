# Sistema de Chatbot Backend Completo ü§ñ

## Descripci√≥n General

Este m√≥dulo implementa un sistema de chatbot completo para el restaurante, con capacidades avanzadas de gesti√≥n, analytics, notificaciones y **personalizaci√≥n de temas**. El sistema est√° dise√±ado para integrarse perfectamente con la infraestructura existente del proyecto Eterials.

## ‚ú® Caracter√≠sticas Principales

### üé® **SISTEMA DE PERSONALIZACI√ìN DE TEMAS** (ACTUALIZADO v2.1.0)
- **4 Temas Predefinidos**: Eterials Cl√°sico, Minimalista Oscuro, Caf√© Warmth, Neon Nights
- **Creaci√≥n de Temas Personalizados**: Editor completo desde el dashboard
- **Preview en Tiempo Real**: Vista previa instant√°nea de cambios
- **Generaci√≥n CSS Autom√°tica**: CSS din√°mico basado en propiedades del tema
- **üñºÔ∏è FONDOS PERSONALIZADOS** (NUEVO):
  - **Upload de Im√°genes**: Subida de fondos personalizados (JPG, PNG, GIF, WEBP)
  - **Miniaturas Autom√°ticas**: Generaci√≥n autom√°tica de thumbnails para preview
  - **Gesti√≥n de Archivos**: Sistema robusto de almacenamiento y limpieza
  - **Estad√≠sticas de Uso**: Tracking de fondos m√°s utilizados
  - **Integraci√≥n con Temas**: Aplicaci√≥n de fondos personalizados a cualquier tema
- **Categor√≠as de Personalizaci√≥n**:
  - üé® **Colores**: Primarios, secundarios, fondos, texto, botones
  - üî§ **Fuentes**: Principales, secundarias, botones, tama√±os
  - üîò **Botones**: Bordes, padding, sombras, efectos hover
  - ‚ú® **Efectos**: Transiciones, animaciones, blur, transformaciones
  - üñºÔ∏è **Fondos**: Gradientes, im√°genes personalizadas, overlays, posicionamiento

### üéØ Gesti√≥n de Sesiones
- Seguimiento completo de sesiones de usuarios
- Almacenamiento de preferencias del cliente
- Historial de interacciones por mesa

### ‚≠ê Sistema de Calificaciones
- Calificaciones de 1-5 estrellas
- Comentarios opcionales de usuarios
- Analytics de satisfacci√≥n del cliente

### üí¨ Gesti√≥n de Comentarios
- Comentarios de clientes con moderaci√≥n
- Categorizaci√≥n autom√°tica
- Respuestas del personal del restaurante

### üîî Notificaciones en Tiempo Real
- Notificaciones al personal del restaurante
- Diferentes tipos: urgente, info, solicitud
- Sistema de estado (pendiente, le√≠do, resuelto)

### üìä Analytics Avanzado
- M√©tricas de uso del chatbot
- An√°lisis de satisfacci√≥n del cliente
- Reportes de actividad por per√≠odos
- Gr√°ficos en tiempo real

### ‚öôÔ∏è Configuraci√≥n Din√°mica
- Configuraciones modificables sin reiniciar
- Saludos personalizados por horario
- Timeouts configurables
- Sistema de temas activos

## üèóÔ∏è Arquitectura del Sistema

### Estructura de Archivos
```
modulos/backend/chatbot/
‚îú‚îÄ‚îÄ models.py                 # üìä Modelos de base de datos (9 tablas + temas + fondos)
‚îú‚îÄ‚îÄ api_endpoints.py          # üåê APIs REST (25+ endpoints + fondos)
‚îú‚îÄ‚îÄ admin_dashboard.py        # üë• Dashboard administrativo + gesti√≥n fondos
‚îú‚îÄ‚îÄ services.py              # üîß Servicios auxiliares
‚îú‚îÄ‚îÄ init_database.py         # üöÄ Inicializador de BD + datos por defecto
‚îú‚îÄ‚îÄ test_backend.py          # üß™ Tests automatizados
‚îî‚îÄ‚îÄ README.md               # üìö Esta documentaci√≥n
```

### Base de Datos

#### Tablas Principales
1. **Sesion** - Sesiones de usuarios del chatbot
2. **Calificacion** - Calificaciones de 1-5 estrellas
3. **Comentario** - Comentarios de clientes
4. **NotificacionMesero** - Notificaciones al personal
5. **Analytics** - Eventos y m√©tricas del sistema
6. **ConfiguracionChatbot** - Configuraciones din√°micas

#### Tablas de Personalizaci√≥n (ACTUALIZADO v2.1.0)
7. **TemaPersonalizacion** - Metadatos de temas
8. **PropiedadTema** - Propiedades CSS por tema
9. **üñºÔ∏è FondoPersonalizado** - **Fondos de imagen personalizados (NUEVO)**
   - Almacena metadatos de im√°genes subidas
   - Miniaturas autom√°ticas y estad√≠sticas de uso
   - Integraci√≥n completa con sistema de temas

### APIs REST Disponibles

#### Gesti√≥n de Sesiones
- `GET /api/chatbot/sesiones` - Listar sesiones
- `POST /api/chatbot/sesiones` - Crear nueva sesi√≥n
- `PUT /api/chatbot/sesiones/{id}` - Actualizar sesi√≥n
- `DELETE /api/chatbot/sesiones/{id}` - Finalizar sesi√≥n

#### Sistema de Calificaciones
- `GET /api/chatbot/calificaciones` - Obtener calificaciones
- `POST /api/chatbot/calificaciones` - Enviar calificaci√≥n
- `GET /api/chatbot/calificaciones/promedio` - Promedio por per√≠odo

#### Gesti√≥n de Comentarios
- `GET /api/chatbot/comentarios` - Listar comentarios
- `POST /api/chatbot/comentarios` - Enviar comentario
- `PUT /api/chatbot/comentarios/{id}/moderar` - Moderar comentario

#### Notificaciones
- `GET /api/chatbot/notificaciones` - Obtener notificaciones
- `POST /api/chatbot/notificaciones` - Crear notificaci√≥n
- `PUT /api/chatbot/notificaciones/{id}/estado` - Cambiar estado

#### Analytics
- `GET /api/chatbot/analytics/resumen` - Resumen de m√©tricas
- `GET /api/chatbot/analytics/graficos` - Datos para gr√°ficos
- `POST /api/chatbot/analytics/evento` - Registrar evento

#### **APIs de Personalizaci√≥n (ACTUALIZADO v2.1.0)**
- `GET /api/chatbot/temas` - Listar todos los temas
- `GET /api/chatbot/temas/{id}` - Detalles de tema espec√≠fico
- `POST /api/chatbot/temas` - Crear tema personalizado
- `PUT /api/chatbot/temas/{id}/propiedades` - Actualizar propiedades
- `POST /api/chatbot/temas/{id}/activar` - Activar tema
- `DELETE /api/chatbot/temas/{id}` - Eliminar tema
- `GET /api/chatbot/temas/activo/css` - **CSS din√°mico del tema activo**

#### **APIs de Fondos Personalizados (NUEVO v2.1.0)**
- `GET /api/chatbot/fondos` - **Listar todos los fondos subidos**
- `POST /api/chatbot/fondos/upload` - **Subir nuevo fondo personalizado**
- `DELETE /api/chatbot/fondos/{id}` - **Eliminar fondo espec√≠fico**
- `PUT /api/chatbot/temas/{id}/fondo` - **Aplicar fondo a tema espec√≠fico**

#### Configuraci√≥n
- `GET /api/chatbot/configuracion` - Obtener configuraciones
- `PUT /api/chatbot/configuracion/{clave}` - Actualizar configuraci√≥n
- `GET /api/chatbot/saludo` - Obtener saludo personalizado

### Dashboard Administrativo

#### Rutas Principales
- `/admin/chatbot/` - Dashboard principal
- `/admin/chatbot/notificaciones` - Panel de notificaciones
- `/admin/chatbot/analytics` - Panel de analytics
- `/admin/chatbot/configuracion` - Configuraci√≥n del sistema

#### **Rutas de Gesti√≥n de Temas (ACTUALIZADO v2.1.0)**
- `/admin/chatbot/temas` - **Gesti√≥n completa de temas**
- `/admin/chatbot/temas/editor/{id}` - **Editor de tema espec√≠fico**
- `/admin/chatbot/temas/preview` - **Vista previa en tiempo real**
- `/admin/chatbot/fondos` - **üñºÔ∏è Gesti√≥n de fondos personalizados**
- `/admin/chatbot/temas/{id}/personalizar` - **üé® Personalizaci√≥n avanzada de temas**

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. Inicializar Base de Datos
```bash
# Ejecutar desde la ra√≠z del proyecto
python modulos/backend/chatbot/init_database.py

# Verificar estado
python modulos/backend/chatbot/init_database.py --verificar
```

### 2. Verificar Integraci√≥n
```bash
# Ejecutar tests autom√°ticos
python modulos/backend/chatbot/test_backend.py

# Espec√≠ficos por m√≥dulo
python modulos/backend/chatbot/test_backend.py --modulo=temas
python modulos/backend/chatbot/test_backend.py --modulo=sesiones
```

### 3. Registrar Blueprint
En tu `main.py` principal:
```python
from modulos.backend.chatbot.api_endpoints import chatbot_api_bp
from modulos.backend.chatbot.admin_dashboard import chatbot_admin_bp

# Registrar blueprints
app.register_blueprint(chatbot_api_bp)
app.register_blueprint(chatbot_admin_bp)
```

## üé® Uso del Sistema de Temas

### Activar un Tema Predefinido
```javascript
// Via API REST
fetch('/api/chatbot/temas/1/activar', {
    method: 'POST'
})
.then(response => response.json())
.then(data => console.log('Tema activado:', data));
```

### Crear Tema Personalizado
```javascript
const nuevoTema = {
    nombre: 'mi_tema_especial',
    descripcion: 'Tema personalizado para eventos',
    propiedades: {
        colores: {
            color_primario: '#ff6b6b',
            color_secundario: '#4ecdc4',
            color_fondo: 'linear-gradient(45deg, #ff6b6b, #4ecdc4)'
        },
        fuentes: {
            fuente_principal: 'Poppins, sans-serif',
            tama√±o_titulo: '3rem'
        },
        botones: {
            boton_border_radius: '30px',
            boton_padding: '15px 30px'
        }
    }
};

fetch('/api/chatbot/temas', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(nuevoTema)
});
```

### Aplicar CSS Din√°mico
```html
<!-- En el template del chatbot -->
<link rel="stylesheet" href="/api/chatbot/temas/activo/css">

<!-- El CSS se genera autom√°ticamente con las variables del tema activo -->
<div class="chatbot-container">
    <h1 class="chatbot-title">¬°Bienvenido!</h1>
    <button class="btn-chatbot">Iniciar Chat</button>
</div>
```

### üñºÔ∏è Gesti√≥n de Fondos Personalizados (NUEVO v2.1.0)

#### Subir Nuevo Fondo
```javascript
// Subir archivo de imagen como fondo personalizado
const formData = new FormData();
formData.append('archivo', imagenFile);
formData.append('nombre', 'Mi Fondo Personalizado');

fetch('/api/chatbot/fondos/upload', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(data => {
    console.log('Fondo subido:', data.fondo);
    // { id: 1, nombre: 'Mi Fondo', archivo_url: '/chatbot/static/fondos/abc123.jpg' }
});
```

#### Aplicar Fondo a Tema
```javascript
// Aplicar fondo personalizado a un tema espec√≠fico
const configuracionFondo = {
    fondo_id: 1,              // ID del fondo subido
    overlay: 'rgba(0,0,0,0.4)', // Overlay para legibilidad
    attachment: 'fixed',       // 'fixed' o 'scroll'
    size: 'cover'             // 'cover', 'contain', 'auto'
};

fetch('/api/chatbot/temas/3/fondo', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(configuracionFondo)
});
```

#### Listar Fondos Disponibles
```javascript
// Obtener todos los fondos subidos con estad√≠sticas
fetch('/api/chatbot/fondos')
.then(response => response.json())
.then(fondos => {
    fondos.forEach(fondo => {
        console.log(`${fondo.nombre}: ${fondo.contador_uso} usos`);
        console.log(`Dimensiones: ${fondo.dimensiones}`);
        console.log(`Miniatura: ${fondo.miniatura_url}`);
    });
});
```

## üîß Configuraci√≥n Avanzada

### Temas Predefinidos Incluidos

#### 1. **Eterials Cl√°sico** (Por defecto)
- Colores dorados y azules elegantes
- Fuentes serif cl√°sicas (Playfair Display)
- Efectos suaves y profesionales

#### 2. **Minimalista Oscuro**
- Colores oscuros con verde azulado
- Fuentes sans-serif modernas (Inter)
- L√≠neas limpias y minimalistas

#### 3. **Caf√© Warmth**
- Tonos c√°lidos marrones y cremas
- Fuentes cursivas (Dancing Script)
- Efectos amigables y acogedores

#### 4. **Neon Nights**
- Colores ne√≥n futuristas
- Fuentes tecnol√≥gicas (Orbitron)
- Efectos brillantes y modernos

### Configuraciones por Defecto
```python
CONFIGURACIONES_DEFAULT = [
    {
        'clave': 'saludo_manana',
        'valor': 'Buenos d√≠as',
        'tipo': 'string',
        'descripcion': 'Saludo para horas de la ma√±ana (6:00 - 11:59)'
    },
    {
        'clave': 'tema_activo',
        'valor': 'eterials_clasico',
        'tipo': 'string',
        'descripcion': 'Tema actualmente activo en el chatbot'
    }
    # ... m√°s configuraciones
]
```

## üìä Analytics y M√©tricas

### Eventos Rastreados
- **Sesiones iniciadas/finalizadas**
- **Calificaciones enviadas**
- **Comentarios publicados**
- **Temas activados** (NUEVO)
- **Configuraciones modificadas**
- **Notificaciones generadas**

### M√©tricas Disponibles
- Sesiones activas en tiempo real
- Promedio de calificaciones por d√≠a/semana/mes
- Comentarios pendientes de moderaci√≥n
- Notificaciones por resolver
- **Temas m√°s utilizados** (NUEVO)
- Tiempo promedio de sesi√≥n

## üß™ Testing

### Tests Automatizados Incluidos
```bash
# Ejecutar suite completa
python test_backend.py

# Tests espec√≠ficos
python test_backend.py --test=test_crear_sesion
python test_backend.py --test=test_sistema_calificaciones
python test_backend.py --test=test_notificaciones_tiempo_real
python test_backend.py --test=test_analytics_basico
python test_backend.py --test=test_configuracion_dinamica
python test_backend.py --test=test_temas_personalizacion  # NUEVO
```

### Casos de Prueba
- ‚úÖ Creaci√≥n y gesti√≥n de sesiones
- ‚úÖ Sistema de calificaciones 1-5 estrellas
- ‚úÖ Comentarios con moderaci√≥n
- ‚úÖ Notificaciones en tiempo real
- ‚úÖ Analytics y m√©tricas
- ‚úÖ Configuraci√≥n din√°mica
- ‚úÖ **Gesti√≥n completa de temas** (NUEVO)
- ‚úÖ **Generaci√≥n CSS din√°mico** (NUEVO)

## üîó Integraci√≥n con Frontend

### Variables CSS Disponibles (Tema Activo)
```css
:root {
    --color-primario: #FFD700;
    --color-secundario: #1e3c72;
    --color-fondo: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --fuente-principal: 'Playfair Display, serif';
    --boton-border-radius: 25px;
    --transicion: 0.3s ease;
    /* ... todas las propiedades del tema activo */
}
```

### Clases CSS Recomendadas
```css
.chatbot-container { /* Usar variables del tema */ }
.btn-chatbot { /* Botones con estilos del tema */ }
.chatbot-title { /* T√≠tulos con fuentes del tema */ }
.message-card { /* Tarjetas con colores del tema */ }
```

## üìà Roadmap Futuro

### Pr√≥ximas Funcionalidades
- üéÆ **Editor visual de temas** con drag & drop
- üåô **Temas autom√°ticos** por horario (d√≠a/noche)
- üé® **Paletas de colores** autom√°ticas
- üì± **Temas espec√≠ficos** para m√≥viles
- üéµ **Integraci√≥n con m√∫sica** ambiente
- üñºÔ∏è **Fondos personalizados** por tema
- üåà **Gradientes din√°micos** generados autom√°ticamente

### Integraciones Planificadas
- üìß Email notifications para comentarios cr√≠ticos
- üîî Push notifications para notificaciones urgentes
- üìä Integraci√≥n con Google Analytics
- üíæ Backup autom√°tico de configuraciones
- üåê API externa para compartir temas

## üÜò Soporte y Documentaci√≥n

### Logs del Sistema
```bash
# Ver logs de actividad
tail -f logs/chatbot_backend.log

# Logs espec√≠ficos de temas
grep "tema_" logs/chatbot_backend.log
```

### Debugging Com√∫n
- **Error de tema no encontrado**: Verificar que exista en BD
- **CSS no se aplica**: Verificar cache del navegador
- **Propiedades faltantes**: Ejecutar inicializador de datos

### Estado del Sistema
```bash
# Verificar estado completo
python init_database.py --verificar

# Estad√≠sticas r√°pidas
curl http://localhost:8080/api/chatbot/analytics/resumen
```

---

## üìû Contacto y Contribuci√≥n

Este sistema fue dise√±ado como parte del proyecto **Eterials Chatbot** con foco en escalabilidad, mantenibilidad y **personalizaci√≥n avanzada**. 

**Caracter√≠sticas √∫nicas del sistema de temas:**
- üé® 4 temas predefinidos profesionales
- üõ†Ô∏è Editor completo desde dashboard 
- ‚ö° Preview en tiempo real
- üîß CSS generado din√°micamente
- üì± Responsive y optimizado
- üéØ Categorizaci√≥n de propiedades

Para contribuciones, reportes de bugs o nuevas funcionalidades, utilizar el sistema de issues del proyecto principal.

---

**Versi√≥n:** 2.0.0 (Con Sistema de Personalizaci√≥n de Temas)  
**√öltima actualizaci√≥n:** Diciembre 2024  
**Compatibilidad:** Python 3.8+, Flask 2.0+, SQLAlchemy 1.4+