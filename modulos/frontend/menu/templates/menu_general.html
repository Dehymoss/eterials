<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ General | Eterials Gastro-Caf√©</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Merriweather:wght@300;400;700&family=Dancing+Script:wght@400;700&family=Caveat:wght@700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('menu.static', filename='style.css') }}?v=20250901b">
</head>
<body>
    <div class="contenedor-central">
        <!-- Header con logo a la izquierda -->
        <header class="header-menu">
            <img src="{{ url_for('menu.static', filename='assets/logo.png') }}" alt="Logo Eterials" class="logo-eterials-izquierda">
            <div class="header-content">
                <h1 class="titulo-menu">Eterials Gastro-Caf√©</h1>
                <p class="subtitulo-elegante">Sabores que despiertan tus sentidos</p>
                <div id="saludo"></div>
            </div>
        </header>
        
        <div class="separador"></div>
        
        <!-- Estado de carga -->
        <div id="estado-carga">
            <p>Cargando men√∫...</p>
        </div>
        
        <!-- Contenedor de categor√≠as -->
        <div id="categorias-container" style="display: none;">
            <h2 class="tiza-amarilla">üçΩÔ∏è Nuestras Categor√≠as</h2>
            <div id="categorias-grid" class="categorias-grid">
                <!-- Las categor√≠as se cargar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Contenedor de productos -->
        <div id="productos-container" style="display: none;">
            <button id="btn-volver" class="boton boton-dorado" onclick="mostrarCategorias()">‚Üê Volver a Categor√≠as</button>
            <div id="categoria-header"></div>
            <div id="productos-grid" class="productos-grid">
                <!-- Los productos se cargar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Mensaje de error -->
        <div id="mensaje-error" style="display: none;">
            <p id="texto-error" style="color: #ffadad;"></p>
            <button class="boton boton-dorado" onclick="cargarMenu()">üîÑ Reintentar</button>
        </div>
    </div>
    
    <!-- Navegaci√≥n inferior fija -->
    <footer class="navegacion-inferior">
        <a id="btn-chatbot" class="boton-chatbot-elegante">üí¨ Volver al Chatbot</a>
    </footer>
    
    <!-- Taza animada -->
    <div class="taza-esquina">
        <img src="{{ url_for('menu.static', filename='assets/taza.png') }}" alt="Eterials taza">
    </div>
    
    <!-- Humareda animada -->
    <div class="humareda">
        <div class="humo-nube humo-nube-0"></div>
        <div class="nota nota-amarilla nota-0"><span>‚ô™</span></div>
        <div class="humo-nube humo-nube-1"></div>
        <div class="nota nota-rosa nota-1"><span>‚ô´</span></div>
        <div class="humo-nube humo-nube-2"></div>
        <div class="nota nota-verde nota-2"><span>‚ô¨</span></div>
        <div class="humo-nube humo-nube-3"></div>
        <div class="nota nota-morada nota-3"><span>‚ô©</span></div>
        <div class="humo-nube humo-nube-4"></div>
        <div class="nota nota-azul nota-4"><span>‚ô≠</span></div>
        <div class="humo-nube humo-nube-5"></div>
        <div class="nota nota-amarilla nota-5"><span>‚ôØ</span></div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES =====
        let menuCompleto = null;
        let categoriaActual = null;
        
        // ===== SALUDO PERSONALIZADO =====
        function inicializarSaludo() {
            const params = new URLSearchParams(window.location.search);
            const nombre = params.get('nombre') || sessionStorage.getItem('nombreCliente') || 'Invitado';
            const mesa = params.get('mesa') || 'Sin asignar';
            
            if (params.get('nombre')) {
                sessionStorage.setItem('nombreCliente', nombre);
            }
            
            const hora = new Date().getHours();
            let saludo = 'Buenas';
            if (hora >= 6 && hora < 12) saludo = 'Buenos d√≠as';
            else if (hora >= 12 && hora < 18) saludo = 'Buenas tardes';
            else saludo = 'Buenas noches';
            
            const mensajeHTML = `
                <span class="saludo-destacado">${saludo} üëã</span><br>
                <span class="saludo-mensaje">
                    ${nombre !== 'Invitado' ? `¬°Bienvenido <b>${nombre}</b>!` : '¬°Bienvenido!'}<br>
                    Mesa <b>${mesa}</b> | Explora nuestras deliciosas opciones<br>
                    üçΩÔ∏è <em>Cada plato es una experiencia √∫nica</em>
                </span>
            `;
            
            document.getElementById('saludo').innerHTML = mensajeHTML;
            
            // Actualizar enlace del chatbot
            const chatbotBtn = document.getElementById('btn-chatbot');
            if (chatbotBtn) {
                let chatbotParams = `mesa=${mesa}`;
                if (nombre !== 'Invitado') {
                    chatbotParams += `&nombre=${encodeURIComponent(nombre)}`;
                }
                chatbotBtn.href = `/chatbot?${chatbotParams}`;
            }
        }
        
        // ===== GESTI√ìN DE ESTADOS =====
        function mostrarEstado(estado) {
            const elementos = ['estado-carga', 'categorias-container', 'productos-container', 'mensaje-error'];
            elementos.forEach(id => {
                document.getElementById(id).style.display = id === estado ? 'block' : 'none';
            });
        }
        
        function mostrarError(mensaje) {
            document.getElementById('texto-error').textContent = mensaje;
            mostrarEstado('mensaje-error');
        }
        
        // ===== CARGA DEL MEN√ö =====
        async function cargarMenu() {
            try {
                console.log('üöÄ Iniciando carga del men√∫...');
                mostrarEstado('estado-carga');
                
                // Cargar categor√≠as
                console.log('üì° Cargando categor√≠as...');
                const categoriasRes = await fetch('/menu-admin/api/categorias/');
                console.log('üì° Respuesta categor√≠as:', categoriasRes.status, categoriasRes.statusText);
                
                if (!categoriasRes.ok) throw new Error(`Error categor√≠as: ${categoriasRes.status}`);
                
                const categoriasData = await categoriasRes.json();
                console.log('üìä Datos categor√≠as recibidos:', categoriasData);
                
                // Cargar productos
                console.log('üì° Cargando productos...');
                const productosRes = await fetch('/menu-admin/api/productos/');
                console.log('üì° Respuesta productos:', productosRes.status, productosRes.statusText);
                
                if (!productosRes.ok) throw new Error(`Error productos: ${productosRes.status}`);
                
                const productosData = await productosRes.json();
                console.log('üìä Datos productos recibidos:', productosData);
                
                // Extraer datos de las respuestas
                const categorias = categoriasData.categorias || [];
                const productos = productosData.productos || [];
                
                console.log('‚úÖ Procesando:', categorias.length, 'categor√≠as y', productos.length, 'productos');
                
                // Validar datos
                if (!Array.isArray(categorias) || !Array.isArray(productos)) {
                    throw new Error('Formato de datos inv√°lido del servidor');
                }
                
                // Guardar datos
                menuCompleto = { categorias, productos };
                mostrarCategorias();
                
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                mostrarError(`No pudimos cargar el men√∫: ${error.message}`);
            }
        }
        
        // ===== MOSTRAR CATEGOR√çAS =====
        function mostrarCategorias() {
            if (!menuCompleto?.categorias || !Array.isArray(menuCompleto.productos)) {
                mostrarError('Error en datos del men√∫');
                return;
            }
            
            const grid = document.getElementById('categorias-grid');
            let html = '';
            
            menuCompleto.categorias.forEach(categoria => {
                const productosDisponibles = menuCompleto.productos.filter(p => 
                    p.categoria_id === categoria.id && p.disponible !== false
                ).length;
                
                html += `
                    <div class="categoria-card" onclick="seleccionarCategoria(${categoria.id}, '${categoria.titulo || categoria.nombre}')">
                        <span class="categoria-icono">${categoria.icono || 'üçΩÔ∏è'}</span>
                        <h3>${categoria.titulo || categoria.nombre}</h3>
                        <p class="categoria-descripcion">${categoria.descripcion || 'Ver productos'}</p>
                        <span class="productos-count">${productosDisponibles} productos</span>
                    </div>
                `;
            });
            
            if (html === '') {
                mostrarError('No hay categor√≠as disponibles');
                return;
            }
            
            grid.innerHTML = html;
            mostrarEstado('categorias-container');
        }
        
        // ===== MOSTRAR PRODUCTOS DE UNA CATEGOR√çA =====
        function seleccionarCategoria(categoriaId, categoriaNombre) {
            console.log('üîç Seleccionando categor√≠a:', categoriaId, categoriaNombre);
            
            if (!menuCompleto || !Array.isArray(menuCompleto.productos)) {
                mostrarError('Error en datos del men√∫');
                return;
            }
            
            console.log('üìã Total productos disponibles:', menuCompleto.productos.length);
            console.log('üìã Productos completos:', menuCompleto.productos);
            
            categoriaActual = menuCompleto.categorias.find(c => c.id === categoriaId);
            const productos = menuCompleto.productos.filter(p => 
                p.categoria_id === categoriaId && p.disponible !== false
            );
            
            console.log('‚úÖ Productos filtrados para categor√≠a', categoriaId, ':', productos.length);
            console.log('üìã Lista de productos filtrados:', productos);
            
            if (!categoriaActual) {
                mostrarError('Categor√≠a no encontrada');
                return;
            }
            
            // Header de la categor√≠a
            const headerHTML = `
                <div class="categoria-header">
                    <h2 class="tiza-amarilla">${categoriaActual.icono || 'üçΩÔ∏è'} ${categoriaNombre}</h2>
                    <p class="categoria-descripcion">${categoriaActual.descripcion || ''}</p>
                </div>
            `;
            document.getElementById('categoria-header').innerHTML = headerHTML;
            
            // Grid de productos - SOLO NOMBRE, PRECIO, DESCRIPCI√ìN
            const grid = document.getElementById('productos-grid');
            let html = '';
            
            productos.forEach(producto => {
                const precio = formatearPrecio(producto.precio || 0);
                
                html += `
                    <div class="producto-card">
                        ${producto.imagen_url ? `
                            <div class="producto-imagen">
                                <img src="${producto.imagen_url}" alt="${producto.nombre}" class="producto-img" 
                                     onload="this.classList.add('loaded')"
                                     onerror="this.src='{{ url_for('menu.static', filename='assets/logo.png') }}'; this.classList.add('loaded');">
                            </div>
                        ` : `
                            <div class="producto-imagen placeholder">
                                <span class="placeholder-icon">üçΩÔ∏è</span>
                            </div>
                        `}
                        
                        <div class="producto-info">
                            <h3 class="producto-nombre">${producto.nombre}</h3>
                            
                            ${producto.descripcion ? `
                                <p class="producto-descripcion">${producto.descripcion}</p>
                            ` : ''}
                            
                            <div class="producto-precio-container">
                                <span class="producto-precio">${precio}</span>
                                <span class="disponible-badge">‚úÖ Disponible</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            mostrarEstado('productos-container');
        }
        
        // ===== NAVEGACI√ìN =====
        function volverACategorias() {
            categoriaActual = null;
            mostrarCategorias();
        }
        
        // ===== UTILIDADES =====
        function formatearPrecio(precio) {
            // Formato colombiano coloquial con "luks"
            if (!precio || precio === 0) return 'Consultar precio';
            
            // Convertir a miles de forma coloquial
            if (precio >= 1000) {
                const miles = Math.floor(precio / 1000);
                const resto = precio % 1000;
                if (resto === 0) {
                    return `${miles} luks`;
                } else if (resto < 100) {
                    return `${miles}.${resto.toString().padStart(3, '0').slice(0, 1)} luks`;
                } else {
                    return `${miles}.${resto.toString().slice(0, 1)} luks`;
                }
            } else {
                return `${precio} pesos`;
            }
        }
        
        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM Content Loaded - Iniciando aplicaci√≥n');
            inicializarSaludo();
            console.log('üëã Saludo inicializado');
            cargarMenu();
            console.log('üìã Funci√≥n cargarMenu() llamada');
        });
    </script>
</body>
</html>
